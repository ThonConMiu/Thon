-- [[ CHEST FARM OPTIMIZED ]] --
_G.AutoFarmChest = true
_G.StopChest = true -- Dừng khi có vật phẩm hiếm
_G.ChestESP = true

local Player = game.Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local Root = Character:WaitForChild("HumanoidRootPart")

-- Fix lỗi đổi team (Chỉ chạy 1 lần để tránh bị Kick)
task.spawn(function()
    if Player.Team == nil or Player.Team.Name == "Choosing" then
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("SetTeam", "Pirates")
    end
end)

-- Hàm tạo ESP rương (Sửa lỗi biến Number)
function CreateESP(obj)
    if not obj:FindFirstChild("ChestVisual") then
        local bill = Instance.new("BillboardGui", obj)
        bill.Name = "ChestVisual"
        bill.AlwaysOnTop = true
        bill.Size = UDim2.new(0, 100, 0, 50)
        bill.Adornee = obj
        
        local txt = Instance.new("TextLabel", bill)
        txt.Size = UDim2.new(1, 0, 1, 0)
        txt.BackgroundTransparency = 1
        txt.Text = obj.Name
        txt.TextColor3 = Color3.new(0, 1, 1)
        txt.TextStrokeTransparency = 0
    end
end

-- Check vật phẩm quan trọng
function HasRareItem()
    local items = {"Fist of Darkness", "God's Chalice"}
    for _, name in pairs(items) do
        if Player.Backpack:FindFirstChild(name) or Character:FindFirstChild(name) then
            return true
        end
    end
    return false
end

-- Script Farm chính
task.spawn(function()
    while task.wait(0.1) do
        if _G.AutoFarmChest then
            if _G.StopChest and HasRareItem() then
                print("Đã tìm thấy đồ hiếm! Dừng Farm.")
                _G.AutoFarmChest = false
                break
            end

            for _, v in pairs(game.Workspace:GetChildren()) do
                if v.Name:find("Chest") and v:IsA("BasePart") then
                    -- ESP
                    if _G.ChestESP then CreateESP(v) end
                    
                    -- Teleport & Collect
                    if _G.AutoFarmChest then
                        repeat
                            task.wait()
                            Root.CFrame = v.CFrame
                            -- Giả lập chạm rương
                            firetouchinterest(Root, v, 0)
                            firetouchinterest(Root, v, 1)
                        until not v.Parent or not _G.AutoFarmChest
                    end
                end
            end
        end
    end
end)

print("=== SCRIPT ĐÃ SỬA: CHẠY ỔN ĐỊNH ===")
