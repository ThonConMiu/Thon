-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Variables
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- Configuration
local CONFIG = {
    DELAY_BETWEEN_TPS = 0.5,
    MIN_CHESTS = 7,
    MAX_CHESTS = 10,
    HEIGHT_OFFSET = 3,
    DELAY_AFTER_RESET = 1,
    JUMP_POWER = 50,
    JUMP_COUNT = 2
}

-- Areas từ script 2
local areas = {
    "Colosseum", "Desert", "Fountain", "Magma", "MobBoss", "Pirate", "Prison", "Sky", "SkyArea1", "SkyArea2", "Town", "MarineBase",
    "Fishmen", "Ice", "MarineStart", "Windmill"
}

-- Variables for chest counter
local chestVisitCount = 0
local currentResetTarget = math.random(CONFIG.MIN_CHESTS, CONFIG.MAX_CHESTS)
local currentChestCFrame = nil
local isLocked = false

local function createGui()
    local gui = Instance.new("ScreenGui")
    gui.Name = "C"..tostring(math.random(1000, 9999))
    gui.IgnoreGuiInset = true
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    gui.DisplayOrder = 999999
    gui.ResetOnSpawn = false
    gui.Parent = player.PlayerGui
    
    -- Background frame full screen
    local background = Instance.new("Frame")
    background.Name = "Background"
    background.Parent = gui
    background.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    background.BackgroundTransparency = 0.7
    background.Size = UDim2.new(1, 0, 1, 0)
    background.Position = UDim2.new(0, 0, 0, 0)
    background.BorderSizePixel = 0
    
    -- Container for centered content
    local container = Instance.new("Frame")
    container.Name = "Container"
    container.Parent = background
    container.Size = UDim2.new(0, 400, 0, 150) -- Fixed size container
    container.Position = UDim2.new(0.5, 0, 0.5, 0) -- Center of screen
    container.AnchorPoint = Vector2.new(0.5, 0.5) -- Center anchor point
    container.BackgroundTransparency = 1
    
    -- Main text
    local mainText = Instance.new("TextLabel")
    mainText.Name = "MainText"
    mainText.Parent = container
    mainText.Size = UDim2.new(1, 0, 0.5, 0) -- Take full container width
    mainText.Position = UDim2.new(0, 0, 0, 0)
    mainText.BackgroundTransparency = 1
    mainText.Text = "Auto Farm Chest"
    mainText.TextColor3 = Color3.fromRGB(255, 255, 255)
    mainText.TextSize = 48
    mainText.Font = Enum.Font.GothamBold
    mainText.AnchorPoint = Vector2.new(0, 0)
    
    -- Credit text
    local creditText = Instance.new("TextLabel")
    creditText.Name = "CreditText"
    creditText.Parent = container
    creditText.Size = UDim2.new(1, 0, 0.3, 0) -- Take full container width
    creditText.Position = UDim2.new(0, 0, 0.6, 0) -- Position below main text
    creditText.BackgroundTransparency = 1
    creditText.Text = "made by VuongDacThong"
    creditText.TextColor3 = Color3.fromRGB(200, 200, 200)
    creditText.TextSize = 24
    creditText.Font = Enum.Font.Gotham
    creditText.AnchorPoint = Vector2.new(0, 0)
    
    -- Add gradient effect to background
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 0, 0)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(20, 20, 20)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 0, 0))
    })
    gradient.Parent = background
    
    -- Add corner radius to background
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = background
    
    -- Animation for gradient
    local tweenService = game:GetService("TweenService")
    local tweenInfo = TweenInfo.new(
        5, -- Time
        Enum.EasingStyle.Linear, -- Easing Style
        Enum.EasingDirection.InOut, -- Easing Direction
        -1, -- Repeat Count (-1 means infinite)
        true -- Reverses
    )
    
    local tween = tweenService:Create(gradient, tweenInfo, {
        Rotation = 360
    })
    tween:Play()
    
    -- Thêm hiệu ứng fade in
    background.BackgroundTransparency = 1
    mainText.TextTransparency = 1
    creditText.TextTransparency = 1
    
    local fadeInfo = TweenInfo.new(
        1, -- Time
        Enum.EasingStyle.Quad,
        Enum.EasingDirection.Out
    )
    
    tweenService:Create(background, fadeInfo, {BackgroundTransparency = 0.7}):Play()
    tweenService:Create(mainText, fadeInfo, {TextTransparency = 0}):Play()
    tweenService:Create(creditText, fadeInfo, {TextTransparency = 0}):Play()
    
    return gui, mainText
end

-- Reset character function
local function resetCharacter()
    if player.Character then
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.Health = 0
        else
            player.Character:BreakJoints()
        end
    end
end

-- Position lock function - TẮT POSITION LOCK
local function startPositionLock()
    -- Không làm gì cả - tắt position lock
end

-- Stop position lock
local function stopPositionLock()
    -- Không làm gì cả - tắt position lock
end

-- Force jump function
local function forceJump()
    if humanoid and humanoid.Health > 0 then
        -- Enable jumping if disabled
        if not humanoid.UseJumpPower then
            humanoid.UseJumpPower = true
        end
        
        -- Set jump power
        humanoid.JumpPower = CONFIG.JUMP_POWER
        
        -- Force jump
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        task.wait(0.1)
        humanoid.Jump = true
        task.wait(0.2)
    end
end

-- Direct teleport function with jump mechanism - CHỈ THAY ĐỔI CÁCH LẤY CHEST
local function teleportToChest(area, index)
    -- Kiểm tra character có tồn tại không
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
        warn("Character hoặc HumanoidRootPart không tìm thấy")
        return false
    end
    
    -- Lấy chest theo cơ chế script 2: workspace.Map -> Area -> Chests
    local chestPath = workspace.Map:FindFirstChild(area)
    if not chestPath then
        return false
    end
    
    local chests = chestPath:FindFirstChild("Chests")
    if not chests then
        return false
    end
    
    local targetChest = chests:GetChildren()[index]
    if not targetChest or not targetChest:IsA("BasePart") then
        return false
    end
    
    -- Phần còn lại giữ nguyên như script 1
    if humanoidRootPart then
        -- Set new chest position
        currentChestCFrame = targetChest.CFrame * CFrame.new(0, CONFIG.HEIGHT_OFFSET, 0)
        
        -- Instant teleport
        humanoidRootPart.CFrame = currentChestCFrame
        
        -- Multiple jumps at the current location
        for i = 1, CONFIG.JUMP_COUNT do
            forceJump()
        end
        
        -- Update chest counter
        chestVisitCount = chestVisitCount + 1
        
        -- Check for reset condition
        if chestVisitCount >= currentResetTarget then
            print(string.format("Collected %d chests, resetting...", currentResetTarget))
            chestVisitCount = 0
            currentResetTarget = math.random(CONFIG.MIN_CHESTS, CONFIG.MAX_CHESTS)
            print(string.format("Next reset will be after %d chests", currentResetTarget))
            
            task.wait(0.5)
            resetCharacter()
            
            -- Wait for new character
            player.CharacterAdded:Wait()
            task.wait(CONFIG.DELAY_AFTER_RESET)
            humanoidRootPart = player.Character:WaitForChild("HumanoidRootPart")
            humanoid = player.Character:WaitForChild("Humanoid")
        end
        
        task.wait(CONFIG.DELAY_BETWEEN_TPS)
        return true
    end
    return false
end

-- Main collection loop - CHỈ THAY ĐỔI CÁCH DUYỆT QUA CHEST
local function collectChestsContinuously()
    local gui, label = createGui()
    
    while true do
        local totalChestsInCycle = 0
        
        -- Duyệt qua từng area (thay vì ChestModels folder)
        for _, area in ipairs(areas) do
            local chestPath = workspace.Map:FindFirstChild(area)
            if chestPath then
                local chestsFolder = chestPath:FindFirstChild("Chests")
                if chestsFolder then
                    local allChests = chestsFolder:GetChildren()
                    
                    -- Lấy tất cả chest trong area này
                    for index, chest in ipairs(allChests) do
                        if chest:IsA("BasePart") then
                            local success = pcall(function()
                                if teleportToChest(area, index) then
                                    totalChestsInCycle = totalChestsInCycle + 1
                                    print(string.format("Teleported to %s Chest %d/%d (Count %d/%d)", 
                                        area, index, #allChests, chestVisitCount, currentResetTarget))
                                end
                            end)
                            
                            if not success then
                                -- Nếu có lỗi, tiếp tục với chest tiếp theo
                                -- warn("Error teleporting to:", area, index)
                            end
                        end
                    end
                end
            end
        end
        
        if totalChestsInCycle > 0 then
            print(string.format("All chests collected (%d chests)!", totalChestsInCycle))
        else
            warn("No chests found in any area!")
        end
        
        -- Add small delay after collecting all chests
        task.wait(0.1)
    end
end

-- Handle character respawning
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    humanoid = character:WaitForChild("Humanoid")
    -- Reset position lock state
    isLocked = false
    currentChestCFrame = nil
end)

-- Cleanup on script stop
game:GetService("Players").LocalPlayer.CharacterRemoving:Connect(function()
    -- Cleanup nếu cần
end)

-- Start the script
if humanoidRootPart and humanoid then
    print(string.format("Starting auto chest, will reset after %d chests", currentResetTarget))
    task.spawn(collectChestsContinuously)
else
    warn("Required character parts not found!")
end
