-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Variables
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- Configuration
local CONFIG = {
    DELAY_BETWEEN_TPS = 1.25,
    HEIGHT_OFFSET = 3,
    DELAY_AFTER_RESET = 1,
    JUMP_POWER = 50,
    JUMP_COUNT = 2,
    RESET_AREAS_ENABLED = true,
    AREAS_ROTATION = {
        "Colosseum", "Desert", "Fountain", "Magma", "MobBoss", "Pirate", 
        "Prison", "Sky", "SkyArea1", "SkyArea2", "Town", "MarineBase",
        "Fishmen", "Ice", "MarineStart", "Windmill"
    }
}

-- Variables for chest counter
local currentChestCFrame = nil
local isLocked = false
local currentAreaIndex = 1
local targetArea = CONFIG.AREAS_ROTATION[currentAreaIndex]

local function createGui()
    local gui = Instance.new("ScreenGui")
    gui.Name = "C"..tostring(math.random(1000, 9999))
    gui.IgnoreGuiInset = true
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    gui.DisplayOrder = 999999
    gui.ResetOnSpawn = false
    gui.Parent = player.PlayerGui
    
    local background = Instance.new("Frame")
    background.Name = "Background"
    background.Parent = gui
    background.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    background.BackgroundTransparency = 0.7
    background.Size = UDim2.new(1, 0, 1, 0)
    background.Position = UDim2.new(0, 0, 0, 0)
    background.BorderSizePixel = 0
    
    local container = Instance.new("Frame")
    container.Name = "Container"
    container.Parent = background
    container.Size = UDim2.new(0, 400, 0, 150)
    container.Position = UDim2.new(0.5, 0, 0.5, 0)
    container.AnchorPoint = Vector2.new(0.5, 0.5)
    container.BackgroundTransparency = 1
    
    local mainText = Instance.new("TextLabel")
    mainText.Name = "MainText"
    mainText.Parent = container
    mainText.Size = UDim2.new(1, 0, 0.5, 0)
    mainText.Position = UDim2.new(0, 0, 0, 0)
    mainText.BackgroundTransparency = 1
    mainText.Text = "Auto Farm Chest"
    mainText.TextColor3 = Color3.fromRGB(255, 255, 255)
    mainText.TextSize = 48
    mainText.Font = Enum.Font.GothamBold
    mainText.AnchorPoint = Vector2.new(0, 0)
    
    local creditText = Instance.new("TextLabel")
    creditText.Name = "CreditText"
    creditText.Parent = container
    creditText.Size = UDim2.new(1, 0, 0.3, 0)
    creditText.Position = UDim2.new(0, 0, 0.6, 0)
    creditText.BackgroundTransparency = 1
    creditText.Text = "made by VuongDacThong"
    creditText.TextColor3 = Color3.fromRGB(200, 200, 200)
    creditText.TextSize = 24
    creditText.Font = Enum.Font.Gotham
    creditText.AnchorPoint = Vector2.new(0, 0)
    
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 0, 0)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(20, 20, 20)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 0, 0))
    })
    gradient.Parent = background
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = background
    
    local tweenService = game:GetService("TweenService")
    local tweenInfo = TweenInfo.new(
        5,
        Enum.EasingStyle.Linear,
        Enum.EasingDirection.InOut,
        -1,
        true
    )
    
    local tween = tweenService:Create(gradient, tweenInfo, {
        Rotation = 360
    })
    tween:Play()
    
    background.BackgroundTransparency = 1
    mainText.TextTransparency = 1
    creditText.TextTransparency = 1
    
    local fadeInfo = TweenInfo.new(
        1,
        Enum.EasingStyle.Quad,
        Enum.EasingDirection.Out
    )
    
    tweenService:Create(background, fadeInfo, {BackgroundTransparency = 0.7}):Play()
    tweenService:Create(mainText, fadeInfo, {TextTransparency = 0}):Play()
    tweenService:Create(creditText, fadeInfo, {TextTransparency = 0}):Play()
    
    return gui, mainText
end

-- Reset character function
local function resetCharacter()
    if player.Character then
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.Health = 0
        else
            player.Character:BreakJoints()
        end
    end
end

-- Position lock function
local function startPositionLock()
    if isLocked then return end
    isLocked = true
    
    if _G.positionLockConnection then
        _G.positionLockConnection:Disconnect()
    end
    
    _G.positionLockConnection = RunService.Heartbeat:Connect(function()
        if humanoidRootPart and currentChestCFrame and isLocked then
            humanoidRootPart.CFrame = currentChestCFrame
            humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
            humanoidRootPart.RotVelocity = Vector3.new(0, 0, 0)
        end
    end)
end

-- Stop position lock
local function stopPositionLock()
    isLocked = false
    if _G.positionLockConnection then
        _G.positionLockConnection:Disconnect()
        _G.positionLockConnection = nil
    end
end

-- Force jump function
local function forceJump()
    if humanoid and humanoid.Health > 0 then
        if not humanoid.UseJumpPower then
            humanoid.UseJumpPower = true
        end
        
        humanoid.JumpPower = CONFIG.JUMP_POWER
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        task.wait(0.1)
        humanoid.Jump = true
        task.wait(0.2)
    end
end

-- Teleport to chest function
local function teleportToChest(area, index)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local chestPath = workspace.Map:FindFirstChild(area)
    if not chestPath then
        return false
    end
    
    local chests = chestPath:FindFirstChild("Chests")
    if not chests then
        return false
    end
    
    local targetChest = chests:GetChildren()[index]
    if not targetChest or not targetChest:IsA("BasePart") then
        return false
    end
    
    if humanoidRootPart then
        currentChestCFrame = targetChest.CFrame * CFrame.new(0, CONFIG.HEIGHT_OFFSET, 0)
        humanoidRootPart.CFrame = currentChestCFrame
        
        for i = 1, CONFIG.JUMP_COUNT do
            forceJump()
        end
        
        task.wait(CONFIG.DELAY_BETWEEN_TPS)
        return true
    end
    return false
end

-- Main collection loop
local function collectChestsContinuously()
    local gui, label = createGui()
    
    while true do
        local totalChestsInCycle = 0
        
        startPositionLock()
        
        -- Farm trong khu vực mục tiêu hiện tại
        local chestPath = workspace.Map:FindFirstChild(targetArea)
        if chestPath then
            local chests = chestPath:FindFirstChild("Chests")
            if chests then
                local allChests = chests:GetChildren()
                
                for index, chest in ipairs(allChests) do
                    if chest:IsA("BasePart") then
                        if teleportToChest(targetArea, index) then
                            totalChestsInCycle = totalChestsInCycle + 1
                            print(string.format("Area: %s | Chest %d/%d", 
                                targetArea, index, #allChests))
                        end
                    end
                end
            end
        end
        
        stopPositionLock()
        
        if totalChestsInCycle > 0 then
            print(string.format("All chests collected in %s (%d chests)! Resetting...", targetArea, totalChestsInCycle))
            
            task.wait(0.5)
            resetCharacter()
            
            -- Chuyển sang area tiếp theo
            currentAreaIndex = currentAreaIndex + 1
            if currentAreaIndex > #CONFIG.AREAS_ROTATION then
                currentAreaIndex = 1
            end
            targetArea = CONFIG.AREAS_ROTATION[currentAreaIndex]
            
            -- Chờ respawn
            player.CharacterAdded:Wait()
            task.wait(CONFIG.DELAY_AFTER_RESET)
            humanoidRootPart = player.Character:WaitForChild("HumanoidRootPart")
            humanoid = player.Character:WaitForChild("Humanoid")
            
            -- Teleport đến area mới
            local areaPath = workspace.Map:FindFirstChild(targetArea)
            if areaPath then
                local chests = areaPath:FindFirstChild("Chests")
                if chests and chests:GetChildren()[1] then
                    humanoidRootPart.CFrame = chests:GetChildren()[1].CFrame * CFrame.new(0, 5, 0)
                end
            end
            
            print(string.format("Switched to area: %s", targetArea))
        else
            warn("No chests found in " .. targetArea)
            task.wait(1)
        end
        
        task.wait(0.1)
    end
end

-- Handle character respawning
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    humanoid = character:WaitForChild("Humanoid")
    isLocked = false
    currentChestCFrame = nil
end)

-- Cleanup on script stop
game:GetService("Players").LocalPlayer.CharacterRemoving:Connect(function()
    stopPositionLock()
end)

-- Start the script
if humanoidRootPart and humanoid then
    print(string.format("Starting auto chest farming in %s", targetArea))
    task.spawn(collectChestsContinuously)
else
    warn("Required character parts not found!")
end
